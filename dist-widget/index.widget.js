require("./index.widget.css");var e=require("react/jsx-runtime"),r=require("react"),n=require("react-dom"),o=require("webrtc-adapter"),t=require("socket.io-client");function a(e){return e&&e.__esModule?e.default:e}s.sessions={},s.isExtensionEnabled=function(){if(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)return!0;if(window.navigator.userAgent.match("Chrome")){var e=parseInt(window.navigator.userAgent.match(/Chrome\/(.*) /)[1],10),r=33;return window.navigator.userAgent.match("Linux")&&(r=35),e>=26&&e<=r||s.extension.isInstalled()}return!0};var i={extensionId:"hapfgfdkleiggjjpfpenajgdnfckjpaj",isInstalled:function(){return null!==document.querySelector("#janus-extension-installed")},getScreen:function(e){var r=window.setTimeout((function(){var r=new Error("NavigatorUserMediaError");return r.name='The required Chrome extension is not installed: click <a href="#">here</a> to install it. (NOTE: this will need you to refresh the page)',e(r)}),1e3);this.cache[r]=e,window.postMessage({type:"janusGetScreen",id:r},"*")},init:function(){var e={};this.cache=e,window.addEventListener("message",(function(r){if(r.origin==window.location.origin)if("janusGotScreen"==r.data.type&&e[r.data.id]){var n=e[r.data.id];if(delete e[r.data.id],""===r.data.sourceId){var o=new Error("NavigatorUserMediaError");o.name="You cancelled the request for permission, giving up...",n(o)}else n(null,r.data.sourceId)}else"janusGetScreenPending"==r.data.type&&(console.log("clearing ",r.data.id),window.clearTimeout(r.data.id))}))}};function s(e){if((e=e||{}).success="function"==typeof e.success?e.success:s.noop,e.error="function"==typeof e.error?e.error:s.noop,e.destroyed="function"==typeof e.destroyed?e.destroyed:s.noop,!s.initDone)return e.error("Library not initialized"),{};if(!s.isWebrtcSupported())return e.error("WebRTC not supported by this browser"),{};if(s.log("Library initialized: "+s.initDone),!e.server)return e.error("Invalid server url"),{};var r=!1,n=null,o={},t=null,a=null,i=0,d=e.server;s.isArray(d)?(s.log("Multiple servers provided ("+d.length+"), will use the first that works"),d=null,a=e.server,s.debug(a)):0===d.indexOf("ws")?(r=!0,s.log("Using WebSockets to contact Janus: "+d)):(r=!1,s.log("Using REST API to contact Janus: "+d));var c=e.iceServers||[{urls:"stun:stun.l.google.com:19302"}],l=e.iceTransportPolicy,u=e.bundlePolicy,f=!0===e.ipv6,g=!1;void 0!==e.withCredentials&&null!==e.withCredentials&&(g=!0===e.withCredentials);var v=10;void 0!==e.max_poll_events&&null!==e.max_poll_events&&(v=e.max_poll_events),v<1&&(v=1);var p=null;void 0!==e.token&&null!==e.token&&(p=e.token);var m=null;void 0!==e.apisecret&&null!==e.apisecret&&(m=e.apisecret),this.destroyOnUnload=!0,void 0!==e.destroyOnUnload&&null!==e.destroyOnUnload&&(this.destroyOnUnload=!0===e.destroyOnUnload);var b=25e3;void 0!==e.keepAlivePeriod&&null!==e.keepAlivePeriod&&(b=e.keepAlivePeriod),isNaN(b)&&(b=25e3);var h=6e4;function w(e){var r={high:9e5,medium:3e5,low:1e5};return null!=e&&(e.high&&(r.high=e.high),e.medium&&(r.medium=e.medium),e.low&&(r.low=e.low)),r}void 0!==e.longPollTimeout&&null!==e.longPollTimeout&&(h=e.longPollTimeout),isNaN(h)&&(h=6e4);var S=!1,y=null,k={},T=this,C=0,A={};function D(){if(null!=y)if(s.debug("Long poll..."),S){var r=d+"/"+y+"?rid="+(new Date).getTime();v&&(r=r+"&maxev="+v),p&&(r=r+"&token="+encodeURIComponent(p)),m&&(r=r+"&apisecret="+encodeURIComponent(m)),s.httpAPICall(r,{verb:"GET",withCredentials:g,success:R,timeout:h,error:function(r,n){if(s.error(r+":",n),++C>3)return S=!1,void e.error("Lost connection to the server (is it down?)");D()}})}else s.warn("Is the server down? (connected=false)")}function R(e,o){if(C=0,r||null==y||!0===o||D(),r||!s.isArray(e))if("keepalive"!==e.janus)if("server_info"!==e.janus)if("ack"!==e.janus)if("success"!==e.janus)if("trickle"===e.janus){const r=e.sender;if(!r)return void s.warn("Missing sender...");const n=k[r];if(!n)return void s.debug("This handle is not attached to this session");var t=e.candidate;s.debug("Got a trickled candidate on session "+y),s.debug(t);var a=n.webrtcStuff;a.pc&&a.remoteSdp?(s.debug("Adding remote candidate:",t),t&&!0!==t.completed?a.pc.addIceCandidate(t):a.pc.addIceCandidate(s.endOfCandidates)):(s.debug("We didn't do setRemoteDescription (trickle got here before the offer?), caching candidate"),a.candidates||(a.candidates=[]),a.candidates.push(t),s.debug(a.candidates))}else{if("webrtcup"===e.janus){s.debug("Got a webrtcup event on session "+y),s.debug(e);const r=e.sender;if(!r)return void s.warn("Missing sender...");const n=k[r];return n?void n.webrtcState(!0):void s.debug("This handle is not attached to this session")}if("hangup"===e.janus){s.debug("Got a hangup event on session "+y),s.debug(e);const r=e.sender;if(!r)return void s.warn("Missing sender...");const n=k[r];if(!n)return void s.debug("This handle is not attached to this session");n.webrtcState(!1,e.reason),n.hangup()}else if("detached"===e.janus){s.debug("Got a detached event on session "+y),s.debug(e);const r=e.sender;if(!r)return void s.warn("Missing sender...");const n=k[r];if(!n)return;n.ondetached(),n.detach()}else if("media"===e.janus){s.debug("Got a media event on session "+y),s.debug(e);const r=e.sender;if(!r)return void s.warn("Missing sender...");const n=k[r];if(!n)return void s.debug("This handle is not attached to this session");n.mediaState(e.type,e.receiving)}else if("slowlink"===e.janus){s.debug("Got a slowlink event on session "+y),s.debug(e);const r=e.sender;if(!r)return void s.warn("Missing sender...");const n=k[r];if(!n)return void s.debug("This handle is not attached to this session");n.slowLink(e.uplink,e.lost)}else{if("error"===e.janus){s.error("Ooops: "+e.error.code+" "+e.error.reason),s.debug(e);var i=e.transaction;if(i){var d=A[i];d&&d(e),delete A[i]}return}if("event"===e.janus){s.debug("Got a plugin event on session "+y),s.debug(e);const r=e.sender;if(!r)return void s.warn("Missing sender...");var c=e.plugindata;if(!c)return void s.warn("Missing plugindata...");s.debug("  -- Event is coming from "+r+" ("+c.plugin+")");var l=c.data;s.debug(l);const n=k[r];if(!n)return void s.warn("This handle is not attached to this session");var u=e.jsep;u&&(s.debug("Handling SDP as well..."),s.debug(u));var f=n.onmessage;f?(s.debug("Notifying application..."),f(l,u)):s.debug("No provided notification callback")}else{if("timeout"===e.janus)return s.error("Timeout on session "+y),s.debug(e),void(r&&n.close(3504,"Gateway timeout"));s.warn("Unknown message/event  '"+e.janus+"' on session "+y),s.debug(e)}}}else{s.debug("Got a success on session "+y),s.debug(e);const r=e.transaction;if(r){const n=A[r];n&&n(e),delete A[r]}}else{s.debug("Got an ack on session "+y),s.debug(e);const r=e.transaction;if(r){const n=A[r];n&&n(e),delete A[r]}}else{s.debug("Got info on the Janus instance"),s.debug(e);const r=e.transaction;if(r){const n=A[r];n&&n(e),delete A[r]}}else s.vdebug("Got a keepalive on session "+y);else for(var g=0;g<e.length;g++)R(e[g],!0)}function I(){if(d&&r&&S){t=setTimeout(I,b);var e={janus:"keepalive",session_id:y,transaction:s.randomString(12)};p&&(e.token=p),m&&(e.apisecret=m),n.send(JSON.stringify(e))}}function x(c){var l=s.randomString(12),u={janus:"create",transaction:l};if(c.reconnect&&(S=!1,u.janus="claim",u.session_id=y,n&&(n.onopen=null,n.onerror=null,n.onclose=null,t&&(clearTimeout(t),t=null))),p&&(u.token=p),m&&(u.apisecret=m),!d&&s.isArray(a)&&(0===(d=a[i]).indexOf("ws")?(r=!0,s.log("Server #"+(i+1)+": trying WebSockets to contact Janus ("+d+")")):(r=!1,s.log("Server #"+(i+1)+": trying REST API to contact Janus ("+d+")"))),r)for(var f in n=s.newWebSocket(d,"janus-protocol"),o={error:function(){if(s.error("Error connecting to the Janus WebSockets server... "+d),s.isArray(a)&&!c.reconnect)return++i===a.length?void c.error("Error connecting to any of the provided Janus servers: Is the server down?"):(d=null,void setTimeout((function(){x(c)}),200));c.error("Error connecting to the Janus WebSockets server: Is the server down?")},open:function(){A[l]=function(e){if(s.debug(e),"success"!==e.janus)return s.error("Ooops: "+e.error.code+" "+e.error.reason),void c.error(e.error.reason);t=setTimeout(I,b),S=!0,y=e.session_id?e.session_id:e.data.id,c.reconnect?s.log("Claimed session: "+y):s.log("Created session: "+y),s.sessions[y]=T,c.success()},n.send(JSON.stringify(u))},message:function(e){R(JSON.parse(e.data))},close:function(){d&&S&&(S=!1,e.error("Lost connection to the server (is it down?)"))}})n.addEventListener(f,o[f]);else s.httpAPICall(d,{verb:"POST",withCredentials:g,body:u,success:function(e){if(s.debug(e),"success"!==e.janus)return s.error("Ooops: "+e.error.code+" "+e.error.reason),void c.error(e.error.reason);S=!0,y=e.session_id?e.session_id:e.data.id,c.reconnect?s.log("Claimed session: "+y):s.log("Created session: "+y),s.sessions[y]=T,D(),c.success()},error:function(e,r){if(s.error(e+":",r),s.isArray(a)&&!c.reconnect)return++i===a.length?void c.error("Error connecting to any of the provided Janus servers: Is the server down?"):(d=null,void setTimeout((function(){x(c)}),200));""===r?c.error(e+": Is the server down?"):r&&r.error?c.error(e+": "+r.error.message):c.error(e+": "+r)}})}function P(e,o){if((o=o||{}).success="function"==typeof o.success?o.success:s.noop,o.error="function"==typeof o.error?o.error:s.noop,!S)return s.warn("Is the server down? (connected=false)"),void o.error("Is the server down? (connected=false)");var t=k[e];if(!t||!t.webrtcStuff)return s.warn("Invalid handle"),void o.error("Invalid handle");var a=o.message,i=o.jsep,c=s.randomString(12),l={janus:"message",body:a,transaction:c};if(t.token&&(l.token=t.token),m&&(l.apisecret=m),i&&(l.jsep={type:i.type,sdp:i.sdp},i.e2ee&&(l.jsep.e2ee=!0),"hml"!==i.rid_order&&"lmh"!==i.rid_order||(l.jsep.rid_order=i.rid_order),i.force_relay&&(l.jsep.force_relay=!0)),s.debug("Sending message to plugin (handle="+e+"):"),s.debug(l),r)return l.session_id=y,l.handle_id=e,A[c]=function(e){if(s.debug("Message sent!"),s.debug(e),"success"===e.janus){var r=e.plugindata;if(!r)return s.warn("Request succeeded, but missing plugindata..."),void o.success();s.log("Synchronous transaction successful ("+r.plugin+")");var n=r.data;return s.debug(n),void o.success(n)}"ack"===e.janus?o.success():e.error?(s.error("Ooops: "+e.error.code+" "+e.error.reason),o.error(e.error.code+" "+e.error.reason)):(s.error("Unknown error"),o.error("Unknown error"))},void n.send(JSON.stringify(l));s.httpAPICall(d+"/"+y+"/"+e,{verb:"POST",withCredentials:g,body:l,success:function(e){if(s.debug("Message sent!"),s.debug(e),"success"===e.janus){var r=e.plugindata;if(!r)return s.warn("Request succeeded, but missing plugindata..."),void o.success();s.log("Synchronous transaction successful ("+r.plugin+")");var n=r.data;return s.debug(n),void o.success(n)}"ack"===e.janus?o.success():e.error?(s.error("Ooops: "+e.error.code+" "+e.error.reason),o.error(e.error.code+" "+e.error.reason)):(s.error("Unknown error"),o.error("Unknown error"))},error:function(e,r){s.error(e+":",r),o.error(e+": "+r)}})}function V(e,o){if(S){var t=k[e];if(t&&t.webrtcStuff){var a={janus:"trickle",candidate:o,transaction:s.randomString(12)};if(t.token&&(a.token=t.token),m&&(a.apisecret=m),s.vdebug("Sending trickle candidate (handle="+e+"):"),s.vdebug(a),r)return a.session_id=y,a.handle_id=e,void n.send(JSON.stringify(a));s.httpAPICall(d+"/"+y+"/"+e,{verb:"POST",withCredentials:g,body:a,success:function(e){s.vdebug("Candidate sent!"),s.vdebug(e),"ack"===e.janus||s.error("Ooops: "+e.error.code+" "+e.error.reason)},error:function(e,r){s.error(e+":",r)}})}else s.warn("Invalid handle")}else s.warn("Is the server down? (connected=false)")}function j(e,r,n,o,t){var a=k[e];if(a&&a.webrtcStuff){var i=a.webrtcStuff;if(i.pc){var d=function(e){s.log("Received state change on data channel:",e);var r=e.target.label,n=e.target.protocol,o=i.dataChannel[r]?i.dataChannel[r].readyState:"null";if(s.log("State change on <"+r+"> data channel: "+o),"open"===o){if(i.dataChannel[r].pending&&i.dataChannel[r].pending.length>0){for(var t of(s.log("Sending pending messages on <"+r+">:",i.dataChannel[r].pending.length),i.dataChannel[r].pending))s.log("Sending data on data channel <"+r+">"),s.debug(t),i.dataChannel[r].send(t);i.dataChannel[r].pending=[]}a.ondataopen(r,n)}};if(o)i.dataChannel[r]=o;else{var c=i.dataChannelOptions;n&&(c.protocol=n),i.dataChannel[r]=i.pc.createDataChannel(r,c)}i.dataChannel[r].onmessage=function(e){s.log("Received message on data channel:",e);var r=e.target.label;a.ondata(e.data,r)},i.dataChannel[r].onopen=d,i.dataChannel[r].onclose=d,i.dataChannel[r].onerror=function(e){s.error("Got error on data channel:",e)},i.dataChannel[r].pending=[],t&&i.dataChannel[r].pending.push(t)}else s.warn("Invalid PeerConnection")}else s.warn("Invalid handle")}function O(e,r){(r=r||{}).success="function"==typeof r.success?r.success:s.noop,r.error="function"==typeof r.error?r.error:s.noop;var n=k[e];if(!n||!n.webrtcStuff)return s.warn("Invalid handle"),void r.error("Invalid handle");var o=n.webrtcStuff,t=r.text||r.data;if(!t)return s.warn("Invalid data"),void r.error("Invalid data");var a=r.label?r.label:s.dataChanDefaultLabel;return o.dataChannel[a]?"open"!==o.dataChannel[a].readyState?(o.dataChannel[a].pending.push(t),void r.success()):(s.log("Sending data on data channel <"+a+">"),s.debug(t),o.dataChannel[a].send(t),void r.success()):(j(e,a,r.protocol,!1,t,r.protocol),void r.success())}function E(e,r){(r=r||{}).success="function"==typeof r.success?r.success:s.noop,r.error="function"==typeof r.error?r.error:s.noop;var n=k[e];if(!n||!n.webrtcStuff)return s.warn("Invalid handle"),void r.error("Invalid handle");var o=n.webrtcStuff;if(!o.dtmfSender){if(o.pc){var t=o.pc.getSenders().find((function(e){return e.track&&"audio"===e.track.kind}));if(!t)return s.warn("Invalid DTMF configuration (no audio track)"),void r.error("Invalid DTMF configuration (no audio track)");o.dtmfSender=t.dtmf,o.dtmfSender&&(s.log("Created DTMF Sender"),o.dtmfSender.ontonechange=function(e){s.debug("Sent DTMF tone: "+e.tone)})}if(!o.dtmfSender)return s.warn("Invalid DTMF configuration"),void r.error("Invalid DTMF configuration")}var a=r.dtmf;if(!a)return s.warn("Invalid DTMF parameters"),void r.error("Invalid DTMF parameters");var i=a.tones;if(!i)return s.warn("Invalid DTMF string"),void r.error("Invalid DTMF string");var d="number"==typeof a.duration?a.duration:500,c="number"==typeof a.gap?a.gap:50;s.debug("Sending DTMF string "+i+" (duration "+d+"ms, gap "+c+"ms)"),o.dtmfSender.insertDTMF(i,d,c),r.success()}function M(e,o){(o=o||{}).success="function"==typeof o.success?o.success:s.noop,o.error="function"==typeof o.error?o.error:s.noop;var t=!0===o.noRequest;s.log("Destroying handle "+e+" (only-locally="+t+")"),G(e);var a=k[e];if(!a||a.detached)return delete k[e],void o.success();if(a.detached=!0,t)return delete k[e],void o.success();if(!S)return s.warn("Is the server down? (connected=false)"),void o.error("Is the server down? (connected=false)");var i={janus:"detach",transaction:s.randomString(12)};if(a.token&&(i.token=a.token),m&&(i.apisecret=m),r)return i.session_id=y,i.handle_id=e,n.send(JSON.stringify(i)),delete k[e],void o.success();s.httpAPICall(d+"/"+y+"/"+e,{verb:"POST",withCredentials:g,body:i,success:function(r){s.log("Destroyed handle:"),s.debug(r),"success"!==r.janus&&s.error("Ooops: "+r.error.code+" "+r.error.reason),delete k[e],o.success()},error:function(r,n){s.error(r+":",n),delete k[e],o.success()}})}function N(e,r,n,o,t){var a=k[e];if(!a||!a.webrtcStuff)return s.warn("Invalid handle"),o.stream||s.stopAllTracks(t),void o.error("Invalid handle");var i=a.webrtcStuff;s.debug("streamsDone:",t),t&&(s.debug("  -- Audio tracks:",t.getAudioTracks()),s.debug("  -- Video tracks:",t.getVideoTracks()));var d=!1;if(i.myStream&&n.update&&(!i.streamExternal||n.replaceAudio||n.replaceVideo)){if((!n.update&&B(n)||n.update&&(n.addAudio||n.replaceAudio))&&t.getAudioTracks()&&t.getAudioTracks().length)if(i.myStream.addTrack(t.getAudioTracks()[0]),s.unifiedPlan){s.log((n.replaceAudio?"Replacing":"Adding")+" audio track:",t.getAudioTracks()[0]);var g=null;const e=i.pc.getTransceivers();if(e&&e.length>0)for(const r of e)if(r.sender&&r.sender.track&&"audio"===r.sender.track.kind||r.receiver&&r.receiver.track&&"audio"===r.receiver.track.kind){g=r;break}g&&g.sender?g.sender.replaceTrack(t.getAudioTracks()[0]):i.pc.addTrack(t.getAudioTracks()[0],t)}else s.log((n.replaceAudio?"Replacing":"Adding")+" audio track:",t.getAudioTracks()[0]),i.pc.addTrack(t.getAudioTracks()[0],t);if((!n.update&&H(n)||n.update&&(n.addVideo||n.replaceVideo))&&t.getVideoTracks()&&t.getVideoTracks().length)if(i.myStream.addTrack(t.getVideoTracks()[0]),s.unifiedPlan){s.log((n.replaceVideo?"Replacing":"Adding")+" video track:",t.getVideoTracks()[0]);var v=null;const e=i.pc.getTransceivers();if(e&&e.length>0)for(const r of e)if(r.sender&&r.sender.track&&"video"===r.sender.track.kind||r.receiver&&r.receiver.track&&"video"===r.receiver.track.kind){v=r;break}v&&v.sender?v.sender.replaceTrack(t.getVideoTracks()[0]):i.pc.addTrack(t.getVideoTracks()[0],t)}else s.log((n.replaceVideo?"Replacing":"Adding")+" video track:",t.getVideoTracks()[0]),i.pc.addTrack(t.getVideoTracks()[0],t)}else i.myStream=t,d=!0;if(!i.pc){var p={iceServers:c,iceTransportPolicy:l,bundlePolicy:u};"chrome"===s.webRTCAdapter.browserDetails.browser&&(p.sdpSemantics=s.webRTCAdapter.browserDetails.version<72?"plan-b":"unified-plan");var m={optional:[{DtlsSrtpKeyAgreement:!0}]};if(f&&m.optional.push({googIPv6:!0}),o.rtcConstraints&&"object"==typeof o.rtcConstraints)for(var b in s.debug("Adding custom PeerConnection constraints:",o.rtcConstraints),o.rtcConstraints)m.optional.push(o.rtcConstraints[b]);"edge"===s.webRTCAdapter.browserDetails.browser&&(p.bundlePolicy="max-bundle"),RTCRtpSender&&(RTCRtpSender.prototype.createEncodedStreams||RTCRtpSender.prototype.createEncodedAudioStreams&&RTCRtpSender.prototype.createEncodedVideoStreams)&&(o.senderTransforms||o.receiverTransforms)&&(i.senderTransforms=o.senderTransforms,i.receiverTransforms=o.receiverTransforms,p.forceEncodedAudioInsertableStreams=!0,p.forceEncodedVideoInsertableStreams=!0,p.encodedInsertableStreams=!0),s.log("Creating PeerConnection"),s.debug(m),i.pc=new RTCPeerConnection(p,m),s.debug(i.pc),i.pc.getStats&&(i.volume={},i.bitrate.value="0 kbits/sec"),s.log("Preparing local SDP and gathering candidates (trickle="+i.trickle+")"),i.pc.oniceconnectionstatechange=function(){i.pc&&a.iceState(i.pc.iceConnectionState)},i.pc.onicecandidate=function(r){if(!r.candidate||"edge"===s.webRTCAdapter.browserDetails.browser&&r.candidate.candidate.indexOf("endOfCandidates")>0)s.log("End of candidates."),i.iceDone=!0,!0===i.trickle?V(e,{completed:!0}):function(e,r){(r=r||{}).success="function"==typeof r.success?r.success:s.noop,r.error="function"==typeof r.error?r.error:s.noop;var n=k[e];if(!n||!n.webrtcStuff)return void s.warn("Invalid handle, not sending anything");var o=n.webrtcStuff;if(s.log("Sending offer/answer SDP..."),!o.mySdp)return void s.warn("Local SDP instance is invalid, not sending anything...");o.mySdp={type:o.pc.localDescription.type,sdp:o.pc.localDescription.sdp},!1===o.trickle&&(o.mySdp.trickle=!1);s.debug(r),o.sdpSent=!0,r.success(o.mySdp)}(e,o);else{var n={candidate:r.candidate.candidate,sdpMid:r.candidate.sdpMid,sdpMLineIndex:r.candidate.sdpMLineIndex};!0===i.trickle&&V(e,n)}},i.pc.ontrack=function(e){if(s.log("Handling Remote Track"),s.debug(e),e.streams&&(i.remoteStream=e.streams[0],a.onremotestream(i.remoteStream),!e.track.onended)){if(i.receiverTransforms){var r=null;RTCRtpSender.prototype.createEncodedStreams?r=e.receiver.createEncodedStreams():(RTCRtpSender.prototype.createAudioEncodedStreams||RTCRtpSender.prototype.createEncodedVideoStreams)&&("audio"===e.track.kind&&i.receiverTransforms.audio?r=e.receiver.createEncodedAudioStreams():"video"===e.track.kind&&i.receiverTransforms.video&&(r=e.receiver.createEncodedVideoStreams())),r&&(console.log(r),r.readableStream&&r.writableStream?r.readableStream.pipeThrough(i.receiverTransforms[e.track.kind]).pipeTo(r.writableStream):r.readable&&r.writable&&r.readable.pipeThrough(i.receiverTransforms[e.track.kind]).pipeTo(r.writable))}var n=null;s.log("Adding onended callback to track:",e.track),e.track.onended=function(e){s.log("Remote track removed:",e),i.remoteStream&&(clearTimeout(n),i.remoteStream.removeTrack(e.target),a.onremotestream(i.remoteStream))},e.track.onmute=function(e){s.log("Remote track muted:",e),i.remoteStream&&null==n&&(n=setTimeout((function(){s.log("Removing remote track"),i.remoteStream&&(i.remoteStream.removeTrack(e.target),a.onremotestream(i.remoteStream)),n=null}),2520))},e.track.onunmute=function(e){if(s.log("Remote track flowing again:",e),null!=n)clearTimeout(n),n=null;else try{i.remoteStream.addTrack(e.target),a.onremotestream(i.remoteStream)}catch(e){s.error(e)}}}}}if(d&&t){s.log("Adding local stream");var h=(!0===o.simulcast||!0===o.simulcast2)&&s.unifiedPlan,S=o.svc;t.getTracks().forEach((function(e){s.log("Adding local track:",e);var r=null;if(!h&&!S||"audio"===e.kind)r=i.pc.addTrack(e,t);else if(h){s.log("Enabling rid-based simulcasting:",e);let n=w(o.simulcastMaxBitrates),a=i.pc.addTransceiver(e,{direction:"sendrecv",streams:[t],sendEncodings:o.sendEncodings||[{rid:"h",active:!0,maxBitrate:n.high},{rid:"m",active:!0,maxBitrate:n.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:n.low,scaleResolutionDownBy:4}]});a&&(r=a.sender)}else{s.log("Enabling SVC ("+S+"):",e);let n=i.pc.addTransceiver(e,{direction:"sendrecv",streams:[t],sendEncodings:[{scalabilityMode:S}]});n&&(r=n.sender)}if(r&&i.senderTransforms){var n=null;RTCRtpSender.prototype.createEncodedStreams?n=r.createEncodedStreams():(RTCRtpSender.prototype.createAudioEncodedStreams||RTCRtpSender.prototype.createEncodedVideoStreams)&&("audio"===r.track.kind&&i.senderTransforms.audio?n=r.createEncodedAudioStreams():"video"===r.track.kind&&i.senderTransforms.video&&(n=r.createEncodedVideoStreams())),n&&(console.log(n),n.readableStream&&n.writableStream?n.readableStream.pipeThrough(i.senderTransforms[r.track.kind]).pipeTo(n.writableStream):n.readable&&n.writable&&n.readable.pipeThrough(i.senderTransforms[r.track.kind]).pipeTo(n.writable))}}))}(function(e){if(s.debug("isDataEnabled:",e),"edge"===s.webRTCAdapter.browserDetails.browser)return s.warn("Edge doesn't support data channels yet"),!1;return null!=e&&!0===e.data})(n)&&!i.dataChannel[s.dataChanDefaultLabel]&&(s.log("Creating default data channel"),j(e,s.dataChanDefaultLabel,null,!1),i.pc.ondatachannel=function(r){s.log("Data channel created by Janus:",r),j(e,r.channel.label,r.channel.protocol,r.channel)}),i.myStream&&a.onlocalstream(i.myStream),r?i.pc.setRemoteDescription(r).then((function(){if(s.log("Remote description accepted!"),i.remoteSdp=r.sdp,i.candidates&&i.candidates.length>0){for(var t=0;t<i.candidates.length;t++){var a=i.candidates[t];s.debug("Adding remote candidate:",a),a&&!0!==a.completed?i.pc.addIceCandidate(a):i.pc.addIceCandidate(s.endOfCandidates)}i.candidates=[]}!function(e,r,n){(n=n||{}).success="function"==typeof n.success?n.success:s.noop,n.error="function"==typeof n.error?n.error:s.noop,n.customizeSdp="function"==typeof n.customizeSdp?n.customizeSdp:s.noop;var o=k[e];if(!o||!o.webrtcStuff)return s.warn("Invalid handle"),void n.error("Invalid handle");var t=o.webrtcStuff,a=!0===n.simulcast||!0===n.simulcast2;a?s.log("Creating answer (iceDone="+t.iceDone+", simulcast="+a+")"):s.log("Creating answer (iceDone="+t.iceDone+")");var i=null;if(s.unifiedPlan){i={};var d=null,c=null,l=t.pc.getTransceivers();if(l&&l.length>0)for(var u of l)u.sender&&u.sender.track&&"audio"===u.sender.track.kind||u.receiver&&u.receiver.track&&"audio"===u.receiver.track.kind?d||(d=u):(u.sender&&u.sender.track&&"video"===u.sender.track.kind||u.receiver&&u.receiver.track&&"video"===u.receiver.track.kind)&&(c||(c=u));var f=B(r),g=z(r);if(f||g){if(f&&g){if(d)try{d.setDirection?d.setDirection("sendrecv"):d.direction="sendrecv",s.log("Setting audio transceiver to sendrecv:",d)}catch(e){s.error(e)}}else if(f&&!g)try{d&&(d.setDirection?d.setDirection("sendonly"):d.direction="sendonly",s.log("Setting audio transceiver to sendonly:",d))}catch(e){s.error(e)}else if(!f&&g)if(d)try{d.setDirection?d.setDirection("recvonly"):d.direction="recvonly",s.log("Setting audio transceiver to recvonly:",d)}catch(e){s.error(e)}else d=t.pc.addTransceiver("audio",{direction:"recvonly"}),s.log("Adding recvonly audio transceiver:",d)}else if(r.removeAudio&&d)try{d.setDirection?d.setDirection("inactive"):d.direction="inactive",s.log("Setting audio transceiver to inactive:",d)}catch(e){s.error(e)}var v=H(r),p=K(r);if(v||p){if(v&&p){if(c)try{c.setDirection?c.setDirection("sendrecv"):c.direction="sendrecv",s.log("Setting video transceiver to sendrecv:",c)}catch(e){s.error(e)}}else if(v&&!p){if(c)try{c.setDirection?c.setDirection("sendonly"):c.direction="sendonly",s.log("Setting video transceiver to sendonly:",c)}catch(e){s.error(e)}}else if(!v&&p)if(c)try{c.setDirection?c.setDirection("recvonly"):c.direction="recvonly",s.log("Setting video transceiver to recvonly:",c)}catch(e){s.error(e)}else c=t.pc.addTransceiver("video",{direction:"recvonly"}),s.log("Adding recvonly video transceiver:",c)}else if(r.removeVideo&&c)try{c.setDirection?c.setDirection("inactive"):c.direction="inactive",s.log("Setting video transceiver to inactive:",c)}catch(e){s.error(e)}}else i="firefox"===s.webRTCAdapter.browserDetails.browser||"edge"===s.webRTCAdapter.browserDetails.browser?{offerToReceiveAudio:z(r),offerToReceiveVideo:K(r)}:{mandatory:{OfferToReceiveAudio:z(r),OfferToReceiveVideo:K(r)}};s.debug(i);var m=H(r);if(m&&a&&"firefox"===s.webRTCAdapter.browserDetails.browser){s.log("Enabling Simulcasting for Firefox (RID)");var b=t.pc.getSenders()[1];s.log(b);var h=b.getParameters();s.log(h);var S=w(n.simulcastMaxBitrates);b.setParameters({encodings:n.sendEncodings||[{rid:"h",active:!0,maxBitrate:S.high},{rid:"m",active:!0,maxBitrate:S.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:S.low,scaleResolutionDownBy:4}]})}t.pc.createAnswer(i).then((function(e){s.debug(e);var r={type:e.type,sdp:e.sdp};n.customizeSdp(r),e.sdp=r.sdp,s.log("Setting local description"),m&&a&&!s.unifiedPlan&&"chrome"===s.webRTCAdapter.browserDetails.browser&&s.warn("simulcast=true, but this is an answer, and video breaks in Chrome if we enable it"),t.mySdp={type:"answer",sdp:e.sdp},t.pc.setLocalDescription(e).catch(n.error),t.mediaConstraints=i,t.iceDone||t.trickle?((t.senderTransforms||t.receiverTransforms)&&(e.e2ee=!0),n.success(e)):s.log("Waiting for all candidates...")}),n.error)}(e,n,o)}),o.error):function(e,r,n){(n=n||{}).success="function"==typeof n.success?n.success:s.noop,n.error="function"==typeof n.error?n.error:s.noop,n.customizeSdp="function"==typeof n.customizeSdp?n.customizeSdp:s.noop;var o=k[e];if(!o||!o.webrtcStuff)return s.warn("Invalid handle"),void n.error("Invalid handle");var t=o.webrtcStuff,a=!0===n.simulcast;a?s.log("Creating offer (iceDone="+t.iceDone+", simulcast="+a+")"):s.log("Creating offer (iceDone="+t.iceDone+")");var i={};if(s.unifiedPlan){var d=null,c=null,l=t.pc.getTransceivers();if(l&&l.length>0)for(var u of l)u.sender&&u.sender.track&&"audio"===u.sender.track.kind||u.receiver&&u.receiver.track&&"audio"===u.receiver.track.kind?d||(d=u):(u.sender&&u.sender.track&&"video"===u.sender.track.kind||u.receiver&&u.receiver.track&&"video"===u.receiver.track.kind)&&(c||(c=u));var f=B(r),g=z(r);f||g?f&&g?d&&(d.setDirection?d.setDirection("sendrecv"):d.direction="sendrecv",s.log("Setting audio transceiver to sendrecv:",d)):f&&!g?d&&(d.setDirection?d.setDirection("sendonly"):d.direction="sendonly",s.log("Setting audio transceiver to sendonly:",d)):!f&&g&&(d?(d.setDirection?d.setDirection("recvonly"):d.direction="recvonly",s.log("Setting audio transceiver to recvonly:",d)):(d=t.pc.addTransceiver("audio",{direction:"recvonly"}),s.log("Adding recvonly audio transceiver:",d))):r.removeAudio&&d&&(d.setDirection?d.setDirection("inactive"):d.direction="inactive",s.log("Setting audio transceiver to inactive:",d));var v=H(r),p=K(r);v||p?v&&p?c&&(c.setDirection?c.setDirection("sendrecv"):c.direction="sendrecv",s.log("Setting video transceiver to sendrecv:",c)):v&&!p?c&&(c.setDirection?c.setDirection("sendonly"):c.direction="sendonly",s.log("Setting video transceiver to sendonly:",c)):!v&&p&&(c?(c.setDirection?c.setDirection("recvonly"):c.direction="recvonly",s.log("Setting video transceiver to recvonly:",c)):(c=t.pc.addTransceiver("video",{direction:"recvonly"}),s.log("Adding recvonly video transceiver:",c))):r.removeVideo&&c&&(c.setDirection?c.setDirection("inactive"):c.direction="inactive",s.log("Setting video transceiver to inactive:",c))}else i.offerToReceiveAudio=z(r),i.offerToReceiveVideo=K(r);!0===n.iceRestart&&(i.iceRestart=!0);s.debug(i);var m=H(r);if(m&&a&&"firefox"===s.webRTCAdapter.browserDetails.browser){s.log("Enabling Simulcasting for Firefox (RID)");var b=t.pc.getSenders().find((function(e){return e.track&&"video"===e.track.kind}));if(b){var h=b.getParameters();h||(h={});var S=w(n.simulcastMaxBitrates);h.encodings=n.sendEncodings||[{rid:"h",active:!0,maxBitrate:S.high},{rid:"m",active:!0,maxBitrate:S.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:S.low,scaleResolutionDownBy:4}],b.setParameters(h)}}t.pc.createOffer(i).then((function(e){s.debug(e);var r={type:e.type,sdp:e.sdp};n.customizeSdp(r),e.sdp=r.sdp,s.log("Setting local description"),m&&a&&!s.unifiedPlan&&("chrome"!==s.webRTCAdapter.browserDetails.browser&&"safari"!==s.webRTCAdapter.browserDetails.browser||(s.log("Enabling Simulcasting for Chrome (SDP munging)"),e.sdp=function(e){var r=e.split("\r\n"),n=!1,o=[-1],t=[-1],a=null,i=null,d=null,c=null,l=-1;for(let v=0;v<r.length;v++){const p=r[v].match(/m=(\w+) */);if(p){if("video"===p[1]){if(!(o[0]<0)){l=v;break}n=!0}else if(o[0]>-1){l=v;break}}else if(n){var u=r[v].match(/a=ssrc-group:SIM (\d+) (\d+) (\d+)/);if(u)return s.warn("The SDP already contains a SIM attribute, munging will be skipped"),e;var f=r[v].match(/a=ssrc-group:FID (\d+) (\d+)/);if(f)o[0]=f[1],t[0]=f[2],r.splice(v,1),v--;else{if(o[0]){var g=r[v].match("a=ssrc:"+o[0]+" cname:(.+)");if(g&&(a=g[1]),g=r[v].match("a=ssrc:"+o[0]+" msid:(.+)"),g&&(i=g[1]),g=r[v].match("a=ssrc:"+o[0]+" mslabel:(.+)"),g&&(d=g[1]),g=r[v].match("a=ssrc:"+o[0]+" label:(.+)"),g&&(c=g[1]),0===r[v].indexOf("a=ssrc:"+t[0])){r.splice(v,1),v--;continue}if(0===r[v].indexOf("a=ssrc:"+o[0])){r.splice(v,1),v--;continue}}0!=r[v].length||(r.splice(v,1),v--)}}}if(o[0]<0){l=-1,n=!1;for(let e=0;e<r.length;e++){const s=r[e].match(/m=(\w+) */);if(s){if("video"===s[1]){if(!(o[0]<0)){l=e;break}n=!0}else if(o[0]>-1){l=e;break}}else if(n){if(o[0]<0){var v=r[e].match(/a=ssrc:(\d+)/);if(v){o[0]=v[1],r.splice(e,1),e--;continue}}else{let n=r[e].match("a=ssrc:"+o[0]+" cname:(.+)");if(n&&(a=n[1]),n=r[e].match("a=ssrc:"+o[0]+" msid:(.+)"),n&&(i=n[1]),n=r[e].match("a=ssrc:"+o[0]+" mslabel:(.+)"),n&&(d=n[1]),n=r[e].match("a=ssrc:"+o[0]+" label:(.+)"),n&&(c=n[1]),0===r[e].indexOf("a=ssrc:"+t[0])){r.splice(e,1),e--;continue}if(0===r[e].indexOf("a=ssrc:"+o[0])){r.splice(e,1),e--;continue}}0!==r[e].length||(r.splice(e,1),e--)}}}if(o[0]<0)return s.warn("Couldn't find the video SSRC, simulcasting NOT enabled"),e;l<0&&(l=r.length);o[1]=Math.floor(4294967295*Math.random()),o[2]=Math.floor(4294967295*Math.random()),t[1]=Math.floor(4294967295*Math.random()),t[2]=Math.floor(4294967295*Math.random());for(var p=0;p<o.length;p++)a&&(r.splice(l,0,"a=ssrc:"+o[p]+" cname:"+a),l++),i&&(r.splice(l,0,"a=ssrc:"+o[p]+" msid:"+i),l++),d&&(r.splice(l,0,"a=ssrc:"+o[p]+" mslabel:"+d),l++),c&&(r.splice(l,0,"a=ssrc:"+o[p]+" label:"+c),l++),a&&(r.splice(l,0,"a=ssrc:"+t[p]+" cname:"+a),l++),i&&(r.splice(l,0,"a=ssrc:"+t[p]+" msid:"+i),l++),d&&(r.splice(l,0,"a=ssrc:"+t[p]+" mslabel:"+d),l++),c&&(r.splice(l,0,"a=ssrc:"+t[p]+" label:"+c),l++);r.splice(l,0,"a=ssrc-group:FID "+o[2]+" "+t[2]),r.splice(l,0,"a=ssrc-group:FID "+o[1]+" "+t[1]),r.splice(l,0,"a=ssrc-group:FID "+o[0]+" "+t[0]),r.splice(l,0,"a=ssrc-group:SIM "+o[0]+" "+o[1]+" "+o[2]),(e=r.join("\r\n")).endsWith("\r\n")||(e+="\r\n");return e}(e.sdp))),t.mySdp={type:"offer",sdp:e.sdp},t.pc.setLocalDescription(e).catch(n.error),t.mediaConstraints=i,t.iceDone||t.trickle?((t.senderTransforms||t.receiverTransforms)&&(e.e2ee=!0),n.success(e)):s.log("Waiting for all candidates...")}),n.error)}(e,n,o)}function L(e,r,n){(n=n||{}).success="function"==typeof n.success?n.success:s.noop,n.error="function"==typeof n.error?n.error:q;var o=n.jsep;if(r&&o)return s.error("Provided a JSEP to a createOffer"),void n.error("Provided a JSEP to a createOffer");if(!(r||o&&o.type&&o.sdp))return s.error("A valid JSEP is required for createAnswer"),void n.error("A valid JSEP is required for createAnswer");n.media="object"==typeof n.media&&n.media?n.media:{audio:!0,video:!0};var t=n.media,a=k[e];if(!a||!a.webrtcStuff)return s.warn("Invalid handle"),void n.error("Invalid handle");var i,d=a.webrtcStuff;if(d.trickle=(i=n.trickle,s.debug("isTrickleEnabled:",i),!1!==i),d.pc){if(s.log("Updating existing media session"),t.update=!0,n.stream)n.stream!==d.myStream&&s.log("Renegotiation involves a new external stream");else{if(t.addAudio){if(t.keepAudio=!1,t.replaceAudio=!1,t.removeAudio=!1,t.audioSend=!0,d.myStream&&d.myStream.getAudioTracks()&&d.myStream.getAudioTracks().length)return s.error("Can't add audio stream, there already is one"),void n.error("Can't add audio stream, there already is one")}else t.removeAudio?(t.keepAudio=!1,t.replaceAudio=!1,t.addAudio=!1,t.audioSend=!1):t.replaceAudio&&(t.keepAudio=!1,t.addAudio=!1,t.removeAudio=!1,t.audioSend=!0);if(d.myStream&&d.myStream.getAudioTracks()&&0!==d.myStream.getAudioTracks().length?!B(t)||t.removeAudio||t.replaceAudio||(t.keepAudio=!0):(t.replaceAudio&&(t.keepAudio=!1,t.replaceAudio=!1,t.addAudio=!0,t.audioSend=!0),B(t)&&(t.keepAudio=!1,t.addAudio=!0)),t.addVideo){if(t.keepVideo=!1,t.replaceVideo=!1,t.removeVideo=!1,t.videoSend=!0,d.myStream&&d.myStream.getVideoTracks()&&d.myStream.getVideoTracks().length)return s.error("Can't add video stream, there already is one"),void n.error("Can't add video stream, there already is one")}else t.removeVideo?(t.keepVideo=!1,t.replaceVideo=!1,t.addVideo=!1,t.videoSend=!1):t.replaceVideo&&(t.keepVideo=!1,t.addVideo=!1,t.removeVideo=!1,t.videoSend=!0);d.myStream&&d.myStream.getVideoTracks()&&0!==d.myStream.getVideoTracks().length?!H(t)||t.removeVideo||t.replaceVideo||(t.keepVideo=!0):(t.replaceVideo&&(t.keepVideo=!1,t.replaceVideo=!1,t.addVideo=!0,t.videoSend=!0),H(t)&&(t.keepVideo=!1,t.addVideo=!0)),t.addData&&(t.data=!0)}if(B(t)&&t.keepAudio&&H(t)&&t.keepVideo)return a.consentDialog(!1),void N(e,o,t,n,d.myStream)}else t.update=!1,t.keepAudio=!1,t.keepVideo=!1;if(t.update&&(!d.streamExternal||d.streamExternal&&(t.replaceAudio||t.replaceVideo))){if(t.removeAudio||t.replaceAudio){if(d.myStream&&d.myStream.getAudioTracks()&&d.myStream.getAudioTracks().length){var c=d.myStream.getAudioTracks()[0];s.log("Removing audio track:",c),d.myStream.removeTrack(c);try{c.stop()}catch(e){}}if(d.pc.getSenders()&&d.pc.getSenders().length){var l=!0;if(t.replaceAudio&&s.unifiedPlan&&(l=!1),l)for(var u of d.pc.getSenders())u&&u.track&&"audio"===u.track.kind&&(s.log("Removing audio sender:",u),d.pc.removeTrack(u))}}if(t.removeVideo||t.replaceVideo){if(d.myStream&&d.myStream.getVideoTracks()&&d.myStream.getVideoTracks().length){var f=d.myStream.getVideoTracks()[0];s.log("Removing video track:",f),d.myStream.removeTrack(f);try{f.stop()}catch(e){}}if(d.pc.getSenders()&&d.pc.getSenders().length){var g=!0;if(t.replaceVideo&&s.unifiedPlan&&(g=!1),g)for(var v of d.pc.getSenders())v&&v.track&&"video"===v.track.kind&&(s.log("Removing video sender:",v),d.pc.removeTrack(v))}}}if(n.stream){var p=n.stream;return s.log("MediaStream provided by the application"),s.debug(p),!t.update||!d.myStream||d.myStream===n.stream||d.streamExternal||t.replaceAudio||t.replaceVideo||(s.stopAllTracks(d.myStream),d.myStream=null),d.streamExternal=!0,a.consentDialog(!1),void N(e,o,t,n,p)}if(B(t)||H(t)){if(!s.isGetUserMediaAvailable())return void n.error("getUserMedia not available");var m={mandatory:{},optional:[]};a.consentDialog(!0);var b=B(t);b&&t&&"object"==typeof t.audio&&(b=t.audio);var h=H(t);if(h&&t){var w=!0===n.simulcast||!0===n.simulcast2,S=n.svc;if(!w&&!S||o||t.video||(t.video="hires"),t.video&&"screen"!=t.video&&"window"!=t.video)if("object"==typeof t.video)h=t.video;else{var y=0,T=0;"lowres"===t.video?(T=240,y=320):"lowres-16:9"===t.video?(T=180,y=320):"hires"===t.video||"hires-16:9"===t.video||"hdres"===t.video?(T=720,y=1280):"fhdres"===t.video?(T=1080,y=1920):"4kres"===t.video?(T=2160,y=3840):"stdres"===t.video?(T=480,y=640):"stdres-16:9"===t.video?(T=360,y=640):(s.log("Default video setting is stdres 4:3"),T=480,y=640),s.log("Adding media constraint:",t.video),h={height:{ideal:T},width:{ideal:y}},s.log("Adding video constraint:",h)}else if("screen"===t.video||"window"===t.video){if(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)return m.video={},t.screenshareFrameRate&&(m.video.frameRate=t.screenshareFrameRate),t.screenshareHeight&&(m.video.height=t.screenshareHeight),t.screenshareWidth&&(m.video.width=t.screenshareWidth),m.audio=t.captureDesktopAudio,void navigator.mediaDevices.getDisplayMedia(m).then((function(r){a.consentDialog(!1),B(t)&&!t.keepAudio?navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then((function(a){r.addTrack(a.getAudioTracks()[0]),N(e,o,t,n,r)})):N(e,o,t,n,r)}),(function(e){a.consentDialog(!1),n.error(e)}));const r=function(r,i){a.consentDialog(!1),r?n.error(r):N(e,o,t,n,i)},i=function(e,r,n){s.log("Adding media constraint (screen capture)"),s.debug(e),navigator.mediaDevices.getUserMedia(e).then((function(e){n?navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then((function(n){e.addTrack(n.getAudioTracks()[0]),r(null,e)})):r(null,e)})).catch((function(e){a.consentDialog(!1),r(e)}))};if("chrome"===s.webRTCAdapter.browserDetails.browser){var C=s.webRTCAdapter.browserDetails.version,A=33;window.navigator.userAgent.match("Linux")&&(A=35),C>=26&&C<=A?(m={video:{mandatory:{googLeakyBucket:!0,maxWidth:window.screen.width,maxHeight:window.screen.height,minFrameRate:t.screenshareFrameRate,maxFrameRate:t.screenshareFrameRate,chromeMediaSource:"screen"}},audio:B(t)&&!t.keepAudio},i(m,r)):s.extension.getScreen((function(e,o){if(e)return a.consentDialog(!1),n.error(e);(m={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",maxWidth:window.screen.width,maxHeight:window.screen.height,minFrameRate:t.screenshareFrameRate,maxFrameRate:t.screenshareFrameRate},optional:[{googLeakyBucket:!0},{googTemporalLayeredScreencast:!0}]}}).video.mandatory.chromeMediaSourceId=o,i(m,r,B(t)&&!t.keepAudio)}))}else if("firefox"===s.webRTCAdapter.browserDetails.browser){if(!(s.webRTCAdapter.browserDetails.version>=33)){var D=new Error("NavigatorUserMediaError");return D.name="Your version of Firefox does not support screen sharing, please install Firefox 33 (or more recent versions)",a.consentDialog(!1),void n.error(D)}m={video:{mozMediaSource:t.video,mediaSource:t.video},audio:B(t)&&!t.keepAudio},i(m,(function(e,n){if(r(e,n),!e)var o=n.currentTime,t=window.setInterval((function(){n||window.clearInterval(t),n.currentTime==o&&(window.clearInterval(t),n.onended&&n.onended()),o=n.currentTime}),500)}))}return}}t&&"screen"===t.video||navigator.mediaDevices.enumerateDevices().then((function(r){var i=r.some((function(e){return"audioinput"===e.kind})),d=function(e){if(s.debug("isScreenSendEnabled:",e),!e)return!1;if("object"!=typeof e.video||"object"!=typeof e.video.mandatory)return!1;var r=e.video.mandatory;if(r.chromeMediaSource)return"desktop"===r.chromeMediaSource||"screen"===r.chromeMediaSource;if(r.mozMediaSource)return"window"===r.mozMediaSource||"screen"===r.mozMediaSource;if(r.mediaSource)return"window"===r.mediaSource||"screen"===r.mediaSource;return!1}(t)||r.some((function(e){return"videoinput"===e.kind})),c=B(t),l=H(t),u=function(e){return s.debug("isAudioSendRequired:",e),!!e&&(!1!==e.audio&&!1!==e.audioSend&&(void 0!==e.failIfNoAudio&&null!==e.failIfNoAudio&&!0===e.failIfNoAudio))}(t),f=function(e){return s.debug("isVideoSendRequired:",e),!!e&&(!1!==e.video&&!1!==e.videoSend&&(void 0!==e.failIfNoVideo&&null!==e.failIfNoVideo&&!0===e.failIfNoVideo))}(t);if(c||l||u||f){var g=!!c&&i,v=!!l&&d;if(!g&&!v)return a.consentDialog(!1),n.error("No capture device found"),!1;if(!g&&u)return a.consentDialog(!1),n.error("Audio capture is required, but no capture device found"),!1;if(!v&&f)return a.consentDialog(!1),n.error("Video capture is required, but no capture device found"),!1}var m={audio:!(!i||t.keepAudio)&&b,video:!(!d||t.keepVideo)&&h};s.debug("getUserMedia constraints",m),m.audio||m.video?navigator.mediaDevices.getUserMedia(m).then((function(r){a.consentDialog(!1),N(e,o,t,n,r)})).catch((function(e){a.consentDialog(!1),n.error({code:e.code,name:e.name,message:e.message})})):(a.consentDialog(!1),N(e,o,t,n,p))})).catch((function(e){a.consentDialog(!1),n.error(e)}))}else N(e,o,t,n)}function _(e,r){(r=r||{}).success="function"==typeof r.success?r.success:s.noop,r.error="function"==typeof r.error?r.error:q,r.customizeSdp="function"==typeof r.customizeSdp?r.customizeSdp:s.noop;var n=r.jsep,o=k[e];if(!o||!o.webrtcStuff)return s.warn("Invalid handle"),void r.error("Invalid handle");var t=o.webrtcStuff;if(n){if(!t.pc)return s.warn("Wait, no PeerConnection?? if this is an answer, use createAnswer and not handleRemoteJsep"),void r.error("No PeerConnection: if this is an answer, use createAnswer and not handleRemoteJsep");r.customizeSdp(n),t.pc.setRemoteDescription(n).then((function(){if(s.log("Remote description accepted!"),t.remoteSdp=n.sdp,t.candidates&&t.candidates.length>0){for(var e=0;e<t.candidates.length;e++){var o=t.candidates[e];s.debug("Adding remote candidate:",o),o&&!0!==o.completed?t.pc.addIceCandidate(o):t.pc.addIceCandidate(s.endOfCandidates)}t.candidates=[]}r.success()}),r.error)}else r.error("Invalid JSEP")}function F(e,r){var n=k[e];if(!n||!n.webrtcStuff)return s.warn("Invalid handle"),0;var o=r?"remote":"local",t=n.webrtcStuff;return t.volume[o]||(t.volume[o]={value:0}),!t.pc.getStats||"chrome"!==s.webRTCAdapter.browserDetails.browser&&"safari"!==s.webRTCAdapter.browserDetails.browser?(s.warn("Getting the "+o+" volume unsupported by browser"),0):r&&!t.remoteStream?(s.warn("Remote stream unavailable"),0):r||t.myStream?t.volume[o].timer?t.volume[o].value:(s.log("Starting "+o+" volume monitor"),t.volume[o].timer=setInterval((function(){t.pc.getStats().then((function(e){e.forEach((function(e){e&&"audio"===e.kind&&(r&&!e.remoteSource||!r&&"media-source"!==e.type||(t.volume[o].value=e.audioLevel?e.audioLevel:0))}))}))}),200),0):(s.warn("Local stream unavailable"),0)}function J(e,r){var n=k[e];if(!n||!n.webrtcStuff)return s.warn("Invalid handle"),!0;var o=n.webrtcStuff;return o.pc?o.myStream?r?o.myStream.getVideoTracks()&&0!==o.myStream.getVideoTracks().length?!o.myStream.getVideoTracks()[0].enabled:(s.warn("No video track"),!0):o.myStream.getAudioTracks()&&0!==o.myStream.getAudioTracks().length?!o.myStream.getAudioTracks()[0].enabled:(s.warn("No audio track"),!0):(s.warn("Invalid local MediaStream"),!0):(s.warn("Invalid PeerConnection"),!0)}function U(e,r,n){var o=k[e];if(!o||!o.webrtcStuff)return s.warn("Invalid handle"),!1;var t=o.webrtcStuff;return t.pc?t.myStream?r?t.myStream.getVideoTracks()&&0!==t.myStream.getVideoTracks().length?(t.myStream.getVideoTracks()[0].enabled=!n,!0):(s.warn("No video track"),!1):t.myStream.getAudioTracks()&&0!==t.myStream.getAudioTracks().length?(t.myStream.getAudioTracks()[0].enabled=!n,!0):(s.warn("No audio track"),!1):(s.warn("Invalid local MediaStream"),!1):(s.warn("Invalid PeerConnection"),!1)}function W(e){var r=k[e];if(!r||!r.webrtcStuff)return s.warn("Invalid handle"),"Invalid handle";var n=r.webrtcStuff;return n.pc?n.pc.getStats?n.bitrate.timer?n.bitrate.value:(s.log("Starting bitrate timer (via getStats)"),n.bitrate.timer=setInterval((function(){n.pc.getStats().then((function(e){e.forEach((function(e){if(e){var r=!1;if(("video"===e.mediaType||e.id.toLowerCase().indexOf("video")>-1)&&"inbound-rtp"===e.type&&e.id.indexOf("rtcp")<0?r=!0:"ssrc"!=e.type||!e.bytesReceived||"VP8"!==e.googCodecName&&""!==e.googCodecName||(r=!0),r)if(n.bitrate.bsnow=e.bytesReceived,n.bitrate.tsnow=e.timestamp,null===n.bitrate.bsbefore||null===n.bitrate.tsbefore)n.bitrate.bsbefore=n.bitrate.bsnow,n.bitrate.tsbefore=n.bitrate.tsnow;else{var o=n.bitrate.tsnow-n.bitrate.tsbefore;"safari"===s.webRTCAdapter.browserDetails.browser&&(o/=1e3);var t=Math.round(8*(n.bitrate.bsnow-n.bitrate.bsbefore)/o);"safari"===s.webRTCAdapter.browserDetails.browser&&(t=parseInt(t/1e3)),n.bitrate.value=t+" kbits/sec",n.bitrate.bsbefore=n.bitrate.bsnow,n.bitrate.tsbefore=n.bitrate.tsnow}}}))}))}),1e3),"0 kbits/sec"):(s.warn("Getting the video bitrate unsupported by browser"),"Feature unsupported by browser"):"Invalid PeerConnection"}function q(e){s.error("WebRTC error:",e)}function G(e,o){s.log("Cleaning WebRTC stuff");var t=k[e];if(t){var a=t.webrtcStuff;if(a){if(!0===o){var i={janus:"hangup",transaction:s.randomString(12)};t.token&&(i.token=t.token),m&&(i.apisecret=m),s.debug("Sending hangup request (handle="+e+"):"),s.debug(i),r?(i.session_id=y,i.handle_id=e,n.send(JSON.stringify(i))):s.httpAPICall(d+"/"+y+"/"+e,{verb:"POST",withCredentials:g,body:i})}a.remoteStream=null,a.volume&&(a.volume.local&&a.volume.local.timer&&clearInterval(a.volume.local.timer),a.volume.remote&&a.volume.remote.timer&&clearInterval(a.volume.remote.timer)),a.volume={},a.bitrate.timer&&clearInterval(a.bitrate.timer),a.bitrate.timer=null,a.bitrate.bsnow=null,a.bitrate.bsbefore=null,a.bitrate.tsnow=null,a.bitrate.tsbefore=null,a.bitrate.value=null,!a.streamExternal&&a.myStream&&(s.log("Stopping local stream tracks"),s.stopAllTracks(a.myStream)),a.streamExternal=!1,a.myStream=null;try{a.pc.close()}catch(e){}a.pc=null,a.candidates=null,a.mySdp=null,a.remoteSdp=null,a.iceDone=!1,a.dataChannel={},a.dtmfSender=null,a.senderTransforms=null,a.receiverTransforms=null}t.oncleanup()}}function B(e){return s.debug("isAudioSendEnabled:",e),!e||!1!==e.audio&&(void 0===e.audioSend||null===e.audioSend||!0===e.audioSend)}function z(e){return s.debug("isAudioRecvEnabled:",e),!e||!1!==e.audio&&(void 0===e.audioRecv||null===e.audioRecv||!0===e.audioRecv)}function H(e){return s.debug("isVideoSendEnabled:",e),!e||!1!==e.video&&(void 0===e.videoSend||null===e.videoSend||!0===e.videoSend)}function K(e){return s.debug("isVideoRecvEnabled:",e),!e||!1!==e.video&&(void 0===e.videoRecv||null===e.videoRecv||!0===e.videoRecv)}x(e),this.getServer=function(){return d},this.isConnected=function(){return S},this.reconnect=function(e){(e=e||{}).success="function"==typeof e.success?e.success:s.noop,e.error="function"==typeof e.error?e.error:s.noop,e.reconnect=!0,x(e)},this.getSessionId=function(){return y},this.getInfo=function(e){!function(e){if((e=e||{}).success="function"==typeof e.success?e.success:s.noop,e.error="function"==typeof e.error?e.error:s.noop,s.log("Getting info on Janus instance"),!S)return s.warn("Is the server down? (connected=false)"),void e.error("Is the server down? (connected=false)");var o=s.randomString(12),t={janus:"info",transaction:o};p&&(t.token=p);m&&(t.apisecret=m);if(r)return A[o]=function(r){s.log("Server info:"),s.debug(r),"server_info"!==r.janus&&s.error("Ooops: "+r.error.code+" "+r.error.reason),e.success(r)},void n.send(JSON.stringify(t));s.httpAPICall(d,{verb:"POST",withCredentials:g,body:t,success:function(r){s.log("Server info:"),s.debug(r),"server_info"!==r.janus&&s.error("Ooops: "+r.error.code+" "+r.error.reason),e.success(r)},error:function(r,n){s.error(r+":",n),""===n?e.error(r+": Is the server down?"):e.error(r+": "+n)}})}(e)},this.destroy=function(a){!function(a){(a=a||{}).success="function"==typeof a.success?a.success:s.noop,a.error="function"==typeof a.error?a.error:s.noop;var i=!0===a.unload,c=!0;void 0!==a.notifyDestroyed&&null!==a.notifyDestroyed&&(c=!0===a.notifyDestroyed);var l=!0===a.cleanupHandles;if(s.log("Destroying session "+y+" (unload="+i+")"),!y)return s.warn("No session to destroy"),a.success(),void(c&&e.destroyed());if(l)for(var u in k)M(u,{noRequest:!0});if(!S)return s.warn("Is the server down? (connected=false)"),y=null,void a.success();var f={janus:"destroy",transaction:s.randomString(12)};p&&(f.token=p);m&&(f.apisecret=m);if(i)return r?(n.onclose=null,n.close(),n=null):navigator.sendBeacon(d+"/"+y,JSON.stringify(f)),s.log("Destroyed session:"),y=null,S=!1,a.success(),void(c&&e.destroyed());if(r){f.session_id=y;var v=function(){for(var e in o)n.removeEventListener(e,o[e]);n.removeEventListener("message",b),n.removeEventListener("error",h),t&&clearTimeout(t),n.close()},b=function(r){var n=JSON.parse(r.data);n.session_id==f.session_id&&n.transaction==f.transaction&&(v(),a.success(),c&&e.destroyed())},h=function(){v(),a.error("Failed to destroy the server: Is the server down?"),c&&e.destroyed()};return n.addEventListener("message",b),n.addEventListener("error",h),void(1===n.readyState?n.send(JSON.stringify(f)):h())}s.httpAPICall(d+"/"+y,{verb:"POST",withCredentials:g,body:f,success:function(r){s.log("Destroyed session:"),s.debug(r),y=null,S=!1,"success"!==r.janus&&s.error("Ooops: "+r.error.code+" "+r.error.reason),a.success(),c&&e.destroyed()},error:function(r,n){s.error(r+":",n),y=null,S=!1,a.success(),c&&e.destroyed()}})}(a)},this.attach=function(e){!function(e){if((e=e||{}).success="function"==typeof e.success?e.success:s.noop,e.error="function"==typeof e.error?e.error:s.noop,e.dataChannelOptions=e.dataChannelOptions||{ordered:!0},e.consentDialog="function"==typeof e.consentDialog?e.consentDialog:s.noop,e.iceState="function"==typeof e.iceState?e.iceState:s.noop,e.mediaState="function"==typeof e.mediaState?e.mediaState:s.noop,e.webrtcState="function"==typeof e.webrtcState?e.webrtcState:s.noop,e.slowLink="function"==typeof e.slowLink?e.slowLink:s.noop,e.onmessage="function"==typeof e.onmessage?e.onmessage:s.noop,e.onlocalstream="function"==typeof e.onlocalstream?e.onlocalstream:s.noop,e.onremotestream="function"==typeof e.onremotestream?e.onremotestream:s.noop,e.ondata="function"==typeof e.ondata?e.ondata:s.noop,e.ondataopen="function"==typeof e.ondataopen?e.ondataopen:s.noop,e.oncleanup="function"==typeof e.oncleanup?e.oncleanup:s.noop,e.ondetached="function"==typeof e.ondetached?e.ondetached:s.noop,!S)return s.warn("Is the server down? (connected=false)"),void e.error("Is the server down? (connected=false)");var o=e.plugin;if(!o)return s.error("Invalid plugin"),void e.error("Invalid plugin");var t=e.opaqueId,a=e.loopIndex,i=e.token?e.token:p,c=s.randomString(12),l={janus:"attach",plugin:o,opaque_id:t,loop_index:a,transaction:c};i&&(l.token=i);m&&(l.apisecret=m);if(r)return A[c]=function(r){if(s.debug(r),"success"!==r.janus)return s.error("Ooops: "+r.error.code+" "+r.error.reason),void e.error("Ooops: "+r.error.code+" "+r.error.reason);var n=r.data.id;s.log("Created handle: "+n);var t={session:T,plugin:o,id:n,token:i,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,remoteStream:null,mySdp:null,mediaConstraints:null,pc:null,dataChannelOptions:e.dataChannelOptions,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,volume:{value:null,timer:null},bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},getId:function(){return n},getPlugin:function(){return o},getVolume:function(){return F(n,!0)},getRemoteVolume:function(){return F(n,!0)},getLocalVolume:function(){return F(n,!1)},isAudioMuted:function(){return J(n,!1)},muteAudio:function(){return U(n,!1,!0)},unmuteAudio:function(){return U(n,!1,!1)},isVideoMuted:function(){return J(n,!0)},muteVideo:function(){return U(n,!0,!0)},unmuteVideo:function(){return U(n,!0,!1)},getBitrate:function(){return W(n)},send:function(e){P(n,e)},data:function(e){O(n,e)},dtmf:function(e){E(n,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){L(n,!0,e)},createAnswer:function(e){L(n,!1,e)},handleRemoteJsep:function(e){_(n,e)},onlocalstream:e.onlocalstream,onremotestream:e.onremotestream,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){G(n,!0===e)},detach:function(e){M(n,e)}};k[n]=t,e.success(t)},l.session_id=y,void n.send(JSON.stringify(l));s.httpAPICall(d+"/"+y,{verb:"POST",withCredentials:g,body:l,success:function(r){if(s.debug(r),"success"!==r.janus)return s.error("Ooops: "+r.error.code+" "+r.error.reason),void e.error("Ooops: "+r.error.code+" "+r.error.reason);var n=r.data.id;s.log("Created handle: "+n);var t={session:T,plugin:o,id:n,token:i,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,remoteStream:null,mySdp:null,mediaConstraints:null,pc:null,dataChannelOptions:e.dataChannelOptions,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,volume:{value:null,timer:null},bitrate:{value:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,timer:null}},getId:function(){return n},getPlugin:function(){return o},getVolume:function(){return F(n,!0)},getRemoteVolume:function(){return F(n,!0)},getLocalVolume:function(){return F(n,!1)},isAudioMuted:function(){return J(n,!1)},muteAudio:function(){return U(n,!1,!0)},unmuteAudio:function(){return U(n,!1,!1)},isVideoMuted:function(){return J(n,!0)},muteVideo:function(){return U(n,!0,!0)},unmuteVideo:function(){return U(n,!0,!1)},getBitrate:function(){return W(n)},send:function(e){P(n,e)},data:function(e){O(n,e)},dtmf:function(e){E(n,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){L(n,!0,e)},createAnswer:function(e){L(n,!1,e)},handleRemoteJsep:function(e){_(n,e)},onlocalstream:e.onlocalstream,onremotestream:e.onremotestream,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){G(n,!0===e)},detach:function(e){M(n,e)}};k[n]=t,e.success(t)},error:function(r,n){s.error(r+":",n),""===n?e.error(r+": Is the server down?"):e.error(r+": "+n)}})}(e)}}s.useDefaultDependencies=function(e){var r=e&&e.fetch||fetch,n=e&&e.Promise||Promise,o=e&&e.WebSocket||WebSocket;return{newWebSocket:function(e,r){return new o(e,r)},extension:e&&e.extension||i,isArray:function(e){return Array.isArray(e)},webRTCAdapter:e&&e.adapter||adapter,httpAPICall:function(e,o){var t={method:o.verb,headers:{Accept:"application/json, text/plain, */*"},cache:"no-cache"};"POST"===o.verb&&(t.headers["Content-Type"]="application/json"),void 0!==o.withCredentials&&(t.credentials=!0===o.withCredentials?"include":o.withCredentials?o.withCredentials:"omit"),o.body&&(t.body=JSON.stringify(o.body));var a=r(e,t).catch((function(e){return n.reject({message:"Probably a network error, is the server down?",error:e})}));if(o.timeout){var i=new n((function(e,r){var n=setTimeout((function(){return clearTimeout(n),r({message:"Request timed out",timeout:o.timeout})}),o.timeout)}));a=n.race([a,i])}return a.then((function(e){return e.ok?typeof o.success==typeof s.noop?e.json().then((function(e){try{o.success(e)}catch(e){s.error("Unhandled httpAPICall success callback error",e)}}),(function(r){return n.reject({message:"Failed to parse response body",error:r,response:e})})):void 0:n.reject({message:"API call failed",response:e})})).catch((function(e){typeof o.error==typeof s.noop&&o.error(e.message||"<< internal error >>",e)})),a}}},s.useOldDependencies=function(e){var r=e&&e.jQuery||jQuery,n=e&&e.WebSocket||WebSocket;return{newWebSocket:function(e,r){return new n(e,r)},isArray:function(e){return r.isArray(e)},extension:e&&e.extension||i,webRTCAdapter:e&&e.adapter||adapter,httpAPICall:function(e,n){var o=void 0!==n.body?{contentType:"application/json",data:JSON.stringify(n.body)}:{},t=void 0!==n.withCredentials?{xhrFields:{withCredentials:n.withCredentials}}:{};return r.ajax(r.extend(o,t,{url:e,type:n.verb,cache:!1,dataType:"json",async:n.async,timeout:n.timeout,success:function(e){typeof n.success==typeof s.noop&&n.success(e)},error:function(e,r,o){typeof n.error==typeof s.noop&&n.error(r,o)}}))}}},s.noop=function(){},s.dataChanDefaultLabel="JanusDataChannel",s.endOfCandidates=null,s.stopAllTracks=function(e){try{var r=e.getTracks();for(var n of r)s.log(n),n&&n.stop()}catch(e){}},s.init=function(e){if((e=e||{}).callback="function"==typeof e.callback?e.callback:s.noop,s.initDone)e.callback();else{if(void 0===console.log&&(console.log=function(){}),s.trace=s.noop,s.debug=s.noop,s.vdebug=s.noop,s.log=s.noop,s.warn=s.noop,s.error=s.noop,!0===e.debug||"all"===e.debug)s.trace=console.trace.bind(console),s.debug=console.debug.bind(console),s.vdebug=console.debug.bind(console),s.log=console.log.bind(console),s.warn=console.warn.bind(console),s.error=console.error.bind(console);else if(Array.isArray(e.debug))for(var r of e.debug)switch(r){case"trace":s.trace=console.trace.bind(console);break;case"debug":s.debug=console.debug.bind(console);break;case"vdebug":s.vdebug=console.debug.bind(console);break;case"log":s.log=console.log.bind(console);break;case"warn":s.warn=console.warn.bind(console);break;case"error":s.error=console.error.bind(console);break;default:console.error("Unknown debugging option '"+r+"' (supported: 'trace', 'debug', 'vdebug', 'log', warn', 'error')")}s.log("Initializing library");var n=e.dependencies||s.useDefaultDependencies();s.isArray=n.isArray,s.webRTCAdapter=n.webRTCAdapter,s.httpAPICall=n.httpAPICall,s.newWebSocket=n.newWebSocket,s.extension=n.extension,s.extension.init(),s.listDevices=function(e,r){e="function"==typeof e?e:s.noop,null==r&&(r={audio:!0,video:!0}),s.isGetUserMediaAvailable()?navigator.mediaDevices.getUserMedia(r).then((function(r){navigator.mediaDevices.enumerateDevices().then((function(n){s.debug(n),e(n),s.stopAllTracks(r)}))})).catch((function(r){s.error(r),e([])})):(s.warn("navigator.mediaDevices unavailable"),e([]))},s.attachMediaStream=function(e,r){try{e.srcObject=r}catch(n){try{e.src=URL.createObjectURL(r)}catch(e){s.error("Error attaching stream to element")}}},s.reattachMediaStream=function(e,r){try{e.srcObject=r.srcObject}catch(n){try{e.src=r.src}catch(e){s.error("Error reattaching stream to element")}}};var o=["iPad","iPhone","iPod"].indexOf(navigator.platform)>=0?"pagehide":"beforeunload",t=window["on"+o];if(window.addEventListener(o,(function(){for(var e in s.log("Closing window"),s.sessions)s.sessions[e]&&s.sessions[e].destroyOnUnload&&(s.log("Destroying session "+e),s.sessions[e].destroy({unload:!0,notifyDestroyed:!1}));t&&"function"==typeof t&&t()})),s.safariVp8=!1,"safari"===s.webRTCAdapter.browserDetails.browser&&s.webRTCAdapter.browserDetails.version>=605)if(RTCRtpSender&&RTCRtpSender.getCapabilities&&RTCRtpSender.getCapabilities("video")&&RTCRtpSender.getCapabilities("video").codecs&&RTCRtpSender.getCapabilities("video").codecs.length){for(var a of RTCRtpSender.getCapabilities("video").codecs)if(a&&a.mimeType&&"video/vp8"===a.mimeType.toLowerCase()){s.safariVp8=!0;break}s.safariVp8?s.log("This version of Safari supports VP8"):s.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu")}else{var i=new RTCPeerConnection({});i.createOffer({offerToReceiveVideo:!0}).then((function(e){s.safariVp8=-1!==e.sdp.indexOf("VP8"),s.safariVp8?s.log("This version of Safari supports VP8"):s.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu"),i.close(),i=null}))}if(s.unifiedPlan=!1,"firefox"===s.webRTCAdapter.browserDetails.browser&&s.webRTCAdapter.browserDetails.version>=59)s.unifiedPlan=!0;else if("chrome"===s.webRTCAdapter.browserDetails.browser&&s.webRTCAdapter.browserDetails.version>=72)s.unifiedPlan=!0;else if(window.RTCRtpTransceiver&&"currentDirection"in RTCRtpTransceiver.prototype){var d=new RTCPeerConnection;try{d.addTransceiver("audio"),s.unifiedPlan=!0}catch(e){}d.close()}else s.unifiedPlan=!1;s.initDone=!0,e.callback()}},s.isWebrtcSupported=function(){return!!window.RTCPeerConnection},s.isGetUserMediaAvailable=function(){return navigator.mediaDevices&&navigator.mediaDevices.getUserMedia},s.randomString=function(e){for(var r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n="",o=0;o<e;o++){var t=Math.floor(Math.random()*r.length);n+=r.substring(t,t+1)}return n};var d=s;const c=({dataConfig:n})=>{const[i,s]=(0,r.useState)(!1),[c,l]=(0,r.useState)(null),[u,f]=(0,r.useState)(null),[g,v]=(0,r.useState)(!1),[p,m]=(0,r.useState)({}),b=(0,r.useRef)(null),h=atob(n).split(":"),w=h[0],S=h[1],y=h[2],k=h[3],T=h[4];let C=!1;const A=e=>{let r="";return r=e&&"<unknown>"!==e.counterpartName&&"string"==typeof e.counterpartName&&e.counterpartName.length>0?e.counterpartName:e&&e.counterpartNum&&"string"==typeof e.counterpartNum&&e.counterpartNum.length>0?e.counterpartNum:"Anonymous",r};return(0,r.useEffect)((()=>{(()=>{const e=(0,t.io)(w,{upgrade:!1,transports:["websocket"],reconnection:!0,reconnectionDelay:2e3});e.on("connect",(()=>{console.log("Socket on: "+w+" is connected !"),e.emit("login",{accessKeyId:S,token:y,uaType:"desktop"})})),e.on("authe_ok",(()=>{console.log("AUTH OK")})),e.on("extenUpdate",(e=>{e.username===S&&(e=>{const r=e.conversations[Object.keys(e.conversations)[0]]||{};if(Object.keys(r).length>0){const n=e.status;n&&"ringing"===n&&m((e=>({...e,displayName:A(r)})))}})(e)}))})(),navigator.mediaDevices.getUserMedia({video:!0,audio:!0});var e={registration_failed:[],registered:[],calling:[],incomingcall:[],accepted:[],hangup:[],gateway_down:[],error:[],progress:[],destroyed:[]};return d.init({debug:"all",dependencies:d.useDefaultDependencies({adapter:a(o)}),callback:function(){const r=new d({server:"https://nv-seb/janus",success:()=>{console.log("success"),r.attach({plugin:"janus.plugin.sip",opaqueId:"sebastian_"+(new Date).getTime(),success:function(e){l(e),(e=>{e.send({message:{request:"register",username:"sip:"+k+"@127.0.0.1",display_name:"Foo 1",secret:T,proxy:"sip:127.0.0.1:5060",sips:!1,refresh:!1}})})(e),e&&console.log("SIP plugin attached! ("+e.getPlugin()+", id = )")},error:function(e){console.error("  -- Error attaching plugin..."),console.error(e)},consentDialog:function(e){console.log(`janus consentDialog (on: ${e})`)},webrtcState:function(e){console.log("Janus says our WebRTC PeerConnection is "+(e?"up":"down")+" now")},iceState:function(e){c&&console.log(`ICE state of PeerConnection of handle has changed to "${e}"`)},mediaState:function(e,r){console.log("Janus "+(r?"started":"stopped")+" receiving our "+e)},slowLink:function(e,r){e?console.warn(`SLOW link: several missing packets from janus (${r})`):console.warn(`SLOW link: janus is not receiving all your packets (${r})`)},onmessage:function(r,n){d.debug(" ::: Got a message :::"),d.debug(JSON.stringify(r));var o=r.error;if(null==o||null==o){var t=r.result;if(null!=t&&void 0!==t.event&&null!==t.event){var a=t.event;for(var i in e[a])e[a][i](r,n);switch(a){case"registration_failed":return void d.error("Registration failed: "+t.code+" "+t.reason);case"unregistered":d.log("Successfully un-registered as "+t.username+"!");break;case"registered":d.log("Successfully registered as "+t.username+"!"),C||(C=!0);break;case"registering":d.log("janus registering");break;case"calling":d.log("Waiting for the peer to answer...");break;case"incomingcall":f(n),s(!0),d.log("Incoming call from "+t.username+"!");break;case"progress":d.log("There's early media from "+t.username+", wairing for the call!");break;case"accepted":v(!0),d.log(t.username+" accepted the call!");break;case"hangup":s(!1),v(!1),486===t.code&&"hangup"===t.event&&"Busy Here"===t.reason&&busyToneSound.play(),d.log("Call hung up ("+t.code+" "+t.reason+")!"),null!=incoming&&(incoming=null),c.hangup()}}}else for(var i in C?c.hangup():d.log("User is not registered"),e.error)e.error[i](r,n)},onlocalstream:function(e){d.debug(" ::: Got a local stream :::"),d.debug(e),d.attachMediaStream(b.current,e),e.getVideoTracks()},onremotestream:function(e){d.debug(" ::: Got a remote stream :::"),d.debug(e),e.getAudioTracks(),e.getVideoTracks()},oncleanup:function(){console.log(" ::: janus Got a cleanup notification :::")},detached:function(){console.warn("SIP plugin handle detached from the plugin itself")}})},error:e=>{console.log("error",e)}})}}),()=>{c&&c.send({message:{request:"unregister"}})}}),[]),(0,e.jsxs)(e.Fragment,{children:[i&&(0,e.jsx)(e.Fragment,{children:(0,e.jsxs)("div",{className:"bg-black px-10 py-8 rounded-3xl flex flex-col gap-5 text-white w-fit absolute bottom-6 left-20 font-sans",children:[(0,e.jsxs)("div",{className:"flex items-center",children:[(0,e.jsx)("span",{children:p.displayName?p.displayName:"-"}),g&&(0,e.jsx)("span",{className:"ml-5 w-3 h-3 bg-red-600 rounded-full"})]}),(0,e.jsxs)("div",{className:"flex gap-3",children:[(0,e.jsx)("button",{onClick:()=>{c.createAnswer({jsep:u,media:{audio:!0,videoSend:!1,videoRecv:!1},success:e=>{c.send({message:{request:"accept"},jsep:e})},error:e=>{d.error("WebRTC error:",e),c.send({message:{request:"decline",code:480}})}})},className:"flex content-center items-center justify-center font-medium tracking-wide transition-colors duration-200 transform focus:outline-none focus:ring-2 focus:z-20 focus:ring-offset-2 disabled:opacity-75 bg-green-600 text-white border border-transparent hover:bg-green-700 focus:ring-green-500 focus:ring-offset-black rounded-md px-3 py-2 text-sm leading-4",children:"Answer"}),(0,e.jsx)("button",{onClick:g?()=>{c.send({message:{request:"hangup"}})}:()=>{c.send({message:{request:"decline"}})},className:"flex content-center items-center justify-center font-medium tracking-wide transition-colors duration-200 transform focus:outline-none focus:ring-2 focus:z-20 focus:ring-offset-2 disabled:opacity-75 bg-red-600 text-white border border-transparent hover:bg-red-700 focus:ring-red-500 focus:ring-offset-black rounded-md px-3 py-2 text-sm leading-4",children:"Decline"})]})]})}),(0,e.jsx)("video",{className:"hidden",ref:b,muted:!0,autoPlay:!0})]})};c.displayName="PhoneIsland";document.querySelectorAll(".phone-island").forEach((o=>{const t=o.getAttribute("data-config")||"";a(n).render((0,e.jsx)(a(r).StrictMode,{children:(0,e.jsx)(c,{dataConfig:t})}),o)}));